name: Release

on:
  release:
    types: [published]

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_QUALITY: 'preview'
  REGISTRY: ghcr.io
  IMAGE_NAME: adrianhall/azurite-ui

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract version from release
      id: version
      run: |
        # Get the tag name from the release event
        TAG="${{ github.event.release.tag_name }}"
        echo "tag=$TAG" >> $GITHUB_OUTPUT

        # Remove 'v' prefix if present (v1.0.0 -> 1.0.0)
        VERSION=${TAG#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

        # Use GitHub's built-in pre-release flag
        IS_PRERELEASE="${{ github.event.release.prerelease }}"
        echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

        if [[ "$IS_PRERELEASE" == "true" ]]; then
          echo "This is a pre-release: $VERSION"
        else
          echo "This is a stable release: $VERSION"
        fi

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        dotnet-quality: ${{ env.DOTNET_QUALITY }}

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Extract Docker metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=raw,value=${{ steps.version.outputs.version }}
          type=raw,value=latest,enable=${{ steps.version.outputs.is_prerelease == 'false' }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64

    - name: Update Release with Docker Info
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.release.tag_name }}
        append_body: true
        body: |

          ---

          ## Docker Image

          This release is available as a Docker container:

          ```bash
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
          ```

          ${{ steps.version.outputs.is_prerelease == 'false' && format('This is a stable release and has also been tagged as `latest`:\n\n```bash\ndocker pull {0}/{1}:latest\n```', env.REGISTRY, env.IMAGE_NAME) || 'This is a pre-release version.' }}
